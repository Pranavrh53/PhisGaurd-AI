<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhishGuard AI - Advanced Threat Detection</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* Add custom styles here */
        .auth-modal .modal-content {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 10px 20px;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-bottom: 3px solid #0d6efd;
            background: transparent;
        }
        .profile-section {
            display: none;
        }
        .user-logged-in .profile-section {
            display: block;
        }
        .user-logged-in .auth-buttons {
            display: none;
        }
    </style>
</head>
<body class="{{ 'user-logged-in' if current_user.is_authenticated else '' }}">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">PhishGuard AI</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#home" data-bs-toggle="tab">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#dashboard" data-bs-toggle="tab">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#history" data-bs-toggle="tab">History</a>
                    </li>
                </ul>
                <div class="auth-buttons" style="display: none;">
                    <button class="btn btn-outline-light me-2" data-bs-toggle="modal" data-bs-target="#authModal">Login</button>
                    <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#authModal" data-tab="signup">Sign Up</button>
                </div>
                <div class="profile-section" style="display: none;">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle" type="button" id="profileDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> <span class="user-email">User</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#profile" data-bs-toggle="tab">Profile</a></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
        <div class="tab-content">
            <!-- Home Tab -->
            <div class="tab-pane fade show active" id="home">
                <!-- Your existing home content here -->
                <div class="text-center py-5">
                    <h1 class="display-4">Welcome to PhishGuard AI</h1>
                    <p class="lead">Advanced Threat Detection & Analysis Platform</p>
                    <div class="mt-4">
                        <button class="btn btn-primary btn-lg me-2" data-bs-toggle="modal" data-bs-target="#authModal">Get Started</button>
                        <a href="#features" class="btn btn-outline-primary btn-lg">Learn More</a>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div class="tab-pane fade" id="dashboard">
                {% include 'dashboard_content.html' %}
            </div>

            <!-- History Tab -->
            <div class="tab-pane fade" id="history">
                {% include 'history_content.html' %}
            </div>

            <!-- Profile Tab -->
            <div class="tab-pane fade" id="profile">
                {% include 'profile_content.html' %}
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal fade auth-modal" id="authModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <ul class="nav nav-tabs w-100" id="authTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login" type="button">Login</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="signup-tab" data-bs-toggle="tab" data-bs-target="#signup" type="button">Sign Up</button>
                        </li>
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="tab-content" id="authTabsContent">
                        <!-- Login Form -->
                        <div class="tab-pane fade show active" id="login" role="tabpanel">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="loginEmail" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="loginEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="loginPassword" required>
                                    <div class="form-text text-end">
                                        <a href="#" id="forgotPassword">Forgot password?</a>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Login</button>
                            </form>
                            <div class="text-center mt-3">
                                <p class="text-muted">Or login with:</p>
                                <button class="btn btn-outline-primary me-2" onclick="signInWithGoogle()">
                                    <i class="fab fa-google me-2"></i> Google
                                </button>
                                <button class="btn btn-outline-dark" onclick="signInWithGithub()">
                                    <i class="fab fa-github me-2"></i> GitHub
                                </button>
                            </div>
                        </div>

                        <!-- Signup Form -->
                        <div class="tab-pane fade" id="signup" role="tabpanel">
                            <form id="signupForm">
                                <div class="mb-3">
                                    <label for="signupEmail" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="signupEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="signupPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="signupPassword" minlength="6" required>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="confirmPassword" minlength="6" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Create Account</button>
                            </form>
                            <div class="text-center mt-3">
                                <p class="text-muted">Or sign up with:</p>
                                <button class="btn btn-outline-primary me-2" onclick="signUpWithGoogle()">
                                    <i class="fab fa-google me-2"></i> Google
                                </button>
                                <button class="btn btn-outline-dark" onclick="signUpWithGithub()">
                                    <i class="fab fa-github me-2"></i> GitHub
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "{{ config.get('FIREBASE_API_KEY') or '' }}",
            authDomain: "{{ config.get('FIREBASE_AUTH_DOMAIN') or '' }}",
            projectId: "{{ config.get('FIREBASE_PROJECT_ID') or '' }}",
            storageBucket: "{{ config.get('FIREBASE_STORAGE_BUCKET') or '' }}",
            messagingSenderId: "{{ config.get('FIREBASE_MESSAGING_SENDER_ID') or '' }}",
            appId: "{{ config.get('FIREBASE_APP_ID') or '' }}",
            measurementId: "{{ config.get('FIREBASE_MEASUREMENT_ID') or '' }}"
        };
        
        // Initialize Firebase only if not already initialized
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        
        try {
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Update navigation based on auth state
        function updateNavigation(isAuthenticated) {
            const authButtons = document.querySelector('.auth-buttons');
            const profileSection = document.querySelector('.profile-section');
            
            if (isAuthenticated) {
                if (authButtons) authButtons.style.display = 'none';
                if (profileSection) profileSection.style.display = 'block';
            } else {
                if (authButtons) authButtons.style.display = 'block';
                if (profileSection) profileSection.style.display = 'none';
            }
        }

        // Handle tab switching in auth modal
        const authModal = document.getElementById('authModal');
        if (authModal) {
            authModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const tab = button.getAttribute('data-tab');
                if (tab) {
                    const triggerTab = new bootstrap.Tab(document.getElementById(`${tab}-tab`));
                    triggerTab.show();
                }
            });
        }

        // Handle login form submission
        document.getElementById('loginForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('User logged in:', userCredential.user);
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                    if (modal) modal.hide();
                    // Update UI
                    updateNavigation(true);
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    alert(error.message);
                });
        });

        // Handle signup form submission
        document.getElementById('signupForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert("Passwords don't match!");
                return;
            }
            
            firebase.auth().createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Send email verification
                    return userCredential.user.sendEmailVerification();
                })
                .then(() => {
                    // Show success message
                    alert('Account created successfully! Please check your email to verify your account.');
                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                    if (modal) modal.hide();
                    // Sign out the user after signup (optional)
                    return firebase.auth().signOut();
                })
                .catch((error) => {
                    console.error('Signup error:', error);
                    alert(error.message);
                });
        });

        // Handle logout
        document.getElementById('logoutBtn')?.addEventListener('click', function() {
            firebase.auth().signOut()
                .then(() => {
                    console.log('User signed out');
                    updateNavigation(false);
                })
                .catch((error) => {
                    console.error('Sign out error:', error);
                    alert(error.message);
                });
        });

        // Auth providers
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider)
                .then(() => {
                    // Handled by auth state change handler
                })
                .catch((error) => {
                    console.error('Google sign-in error:', error);
                    alert(error.message);
                });
        }

        function signInWithGithub() {
            const provider = new firebase.auth.GithubAuthProvider();
            firebase.auth().signInWithPopup(provider)
                .then(() => {
                    // Handled by auth state change handler
                })
                .catch((error) => {
                    console.error('GitHub sign-in error:', error);
                    alert(error.message);
                });
        }

        function signUpWithGoogle() {
            signInWithGoogle(); // Reuse the same function for sign up
        }

        function signUpWithGithub() {
            signInWithGithub(); // Reuse the same function for sign up
        }

        // Check auth state
        firebase.auth().onAuthStateChanged((user) => {
            console.log('Auth state changed:', user ? 'User signed in' : 'No user signed in');
            const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
            if (authModal) {
                authModal.hide();
            }
            
            if (user) {
                // Update UI for logged-in user
                document.body.classList.add('user-logged-in');
                // Update user info in the UI
                const userEmailElement = document.querySelector('#profileDropdown i');
                if (userEmailElement) {
                    userEmailElement.textContent = user.email;
                }
                // User is signed in
                document.body.classList.add('user-logged-in');
                
                // Update the profile dropdown with user info
                const profileDropdown = document.getElementById('profileDropdown');
                if (profileDropdown) {
                    const emailSpan = profileDropdown.querySelector('.user-email');
                    if (emailSpan) {
                        emailSpan.textContent = user.email;
                    }
                }
                
                // Close auth modal if open
                const modal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
                if (modal) modal.hide();
                
                // Update navigation
                updateNavigation(true);
                
                // Check if email is verified
                if (!user.emailVerified) {
                    console.log('Email not verified');
                    // Optionally show a message to verify email
                }
            } else {
                // User is signed out
                document.body.classList.remove('user-logged-in');
                // Reset forms
                const forms = document.querySelectorAll('form');
                forms.forEach(form => form.reset());
                // Show login tab by default
                const loginTab = document.querySelector('#login-tab');
                if (loginTab) {
                    const tab = new bootstrap.Tab(loginTab);
                    tab.show();
                }
            }
            updateNavigation(false);
        });
    </script>
</body>
</html>
