<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhishGuard AI - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-900: #1e3a8a;
            
            --success-500: #10b981;
            --success-600: #059669;
            
            --danger-500: #ef4444;
            --danger-600: #dc2626;
            
            --warning-500: #f59e0b;
            --warning-600: #d97706;
            
            --dark-bg-primary: #0f172a;
            --dark-bg-secondary: #1e293b;
            --dark-bg-tertiary: #334155;
            --dark-text-primary: #f8fafc;
            --dark-text-secondary: #e2e8f0;
            --dark-text-muted: #94a3b8;
            --dark-border: #334155;
            --dark-border-hover: #475569;
            
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 250ms ease-in-out;
            --transition-slow: 350ms ease-in-out;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #060404;
            color: var(--dark-text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .sidebar {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
            min-height: 100vh;
            color: white;
            border-right: 1px solid var(--dark-border);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }
        
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-500), var(--primary-600), var(--primary-500), transparent);
            opacity: 0.8;
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .nav-link {
            color: var(--dark-text-muted);
            transition: all var(--transition-normal);
            border-radius: 0.75rem;
            padding: 0.875rem 1rem;
            margin: 0.25rem 0.5rem;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--primary-500), var(--primary-600));
            transform: scaleY(0);
            transition: transform var(--transition-normal);
        }
        
        .nav-link:hover, .nav-link.active {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            color: var(--dark-text-primary);
            transform: translateX(4px);
        }
        
        .nav-link.active::before {
            transform: scaleY(1);
        }
        
        .nav-link i {
            width: 1.5rem;
            text-align: center;
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }
        
        .card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            border-radius: 1rem;
            border: 1px solid var(--dark-border);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-500), transparent);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2), 0 0 30px rgba(59, 130, 246, 0.2);
            border-color: var(--primary-500);
        }
        
        .card:hover::before {
            opacity: 1;
        }
        
        .history-item {
            border-left: 4px solid transparent;
            transition: all var(--transition-normal);
            border-radius: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        .history-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--primary-500), var(--primary-600));
            transform: scaleY(0);
            transition: transform var(--transition-normal);
        }
        
        .history-item:hover {
            transform: translateX(4px) scale(1.01);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .history-item:hover::before {
            transform: scaleY(1);
        }
        
        .history-item.malicious::before {
            background: linear-gradient(180deg, var(--danger-500), var(--danger-600));
        }
        
        .history-item.benign::before {
            background: linear-gradient(180deg, var(--success-500), var(--success-600));
        }
        
        .stat-card {
            border-left: 4px solid var(--primary-500);
            position: relative;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .stat-card:hover::after {
            opacity: 1;
        }
        
        .stat-card.danger {
            border-left-color: var(--danger-500);
        }
        
        .stat-card.danger::after {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%);
        }
        
        .stat-card.success {
            border-left-color: var(--success-500);
        }
        
        .stat-card.success::after {
            background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
        }
        
        .stat-card.warning {
            border-left-color: var(--warning-500);
        }
        
        .stat-card.warning::after {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.1) 0%, transparent 70%);
        }
        
        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
            transition: all var(--transition-normal);
        }
        
        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.5);
        }
        
        .stat-card.success .stat-icon {
            background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
            box-shadow: 0 4px 14px 0 rgba(16, 185, 129, 0.4);
        }
        
        .stat-card.success:hover .stat-icon {
            box-shadow: 0 6px 20px 0 rgba(16, 185, 129, 0.5);
        }
        
        .stat-card.danger .stat-icon {
            background: linear-gradient(135deg, var(--danger-500) 0%, var(--danger-600) 100%);
            box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.4);
        }
        
        .stat-card.danger:hover .stat-icon {
            box-shadow: 0 6px 20px 0 rgba(239, 68, 68, 0.5);
        }
        
        .stat-card.warning .stat-icon {
            background: linear-gradient(135deg, var(--warning-500) 0%, var(--warning-600) 100%);
            box-shadow: 0 4px 14px 0 rgba(245, 158, 11, 0.4);
        }
        
        .stat-card.warning:hover .stat-icon {
            box-shadow: 0 6px 20px 0 rgba(245, 158, 11, 0.5);
        }
        
        header {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            border-bottom: 1px solid var(--dark-border);
            backdrop-filter: blur(20px);
        }
        
        .quick-action-btn {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border: 1px solid var(--dark-border);
            color: var(--dark-text-primary);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
            transition: left var(--transition-slow);
        }
        
        .quick-action-btn:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(59, 130, 246, 0.1) 100%);
            border-color: var(--primary-500);
            transform: translateX(4px);
        }
        
        .quick-action-btn:hover::before {
            left: 100%;
        }
        
        .badge {
            padding: 0.5em 0.75em;
            font-size: 0.75em;
            font-weight: 700;
            border-radius: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        main {
            background: #060404;
        }
    </style>
</head>
<body class="flex h-screen">
    <!-- Sidebar -->
    <div class="sidebar w-64 flex-shrink-0 hidden md:block">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-white mb-2">
                <i class="fas fa-shield-alt mr-2 text-blue-400"></i>PhishGuard AI
            </h1>
            <p class="text-sm mt-1" style="color: var(--dark-text-muted);">Advanced Phishing Detection</p>
        </div>
        
        <nav class="mt-8 px-4">
            <a href="/dashboard" class="nav-link flex items-center active">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="/" class="nav-link flex items-center">
                <i class="fas fa-search"></i>
                <span>Quick Scan</span>
            </a>
            <a href="/advanced_analysis" class="nav-link flex items-center">
                <i class="fas fa-shield-alt"></i>
                <span>Advanced Analysis</span>
            </a>
            <a href="#" class="nav-link flex items-center">
                <i class="fas fa-history"></i>
                <span>Scan History</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Navigation -->
        <header>
            <div class="flex justify-between items-center p-4">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="md:hidden mr-4" style="color: var(--dark-text-muted);">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <h2 class="text-xl font-semibold" style="color: var(--dark-text-primary);">Dashboard</h2>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <i class="fas fa-bell cursor-pointer" style="color: var(--dark-text-muted);"></i>
                        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">3</span>
                    </div>
                    <div class="h-8 w-8 rounded-full flex items-center justify-center font-semibold" style="background: linear-gradient(135deg, var(--primary-500), var(--primary-600)); color: white;">
                        U
                    </div>
                    <button id="logout-btn" class="text-sm" style="color: var(--dark-text-muted);">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card p-6 stat-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium mb-2" style="color: var(--dark-text-muted);">Total Scans</p>
                            <h3 class="text-3xl font-bold" style="color: var(--dark-text-primary);" id="total-scans">0</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6 stat-card success">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium mb-2" style="color: var(--dark-text-muted);">Safe Items</p>
                            <h3 class="text-3xl font-bold" style="color: var(--dark-text-primary);" id="safe-items">0</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6 stat-card danger">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium mb-2" style="color: var(--dark-text-muted);">Threats Detected</p>
                            <h3 class="text-3xl font-bold" style="color: var(--dark-text-primary);" id="threats-detected">0</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
                
                <div class="card p-6 stat-card warning">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium mb-2" style="color: var(--dark-text-muted);">Suspicious</p>
                            <h3 class="text-3xl font-bold" style="color: var(--dark-text-primary);" id="suspicious-items">0</h3>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div class="lg:col-span-2">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold" style="color: var(--dark-text-primary);">Recent Scans</h3>
                            <a href="#" class="text-sm" style="color: var(--primary-500);">View All</a>
                        </div>
                        <div id="analysis-history" class="space-y-4">
                            <!-- History items will be loaded here -->
                            <div class="text-center py-8" style="color: var(--dark-text-muted);">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading scan history...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-6" style="color: var(--dark-text-primary);">Threat Distribution</h3>
                        <div class="h-64">
                            <canvas id="threatChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="card p-6 mt-6">
                        <h3 class="text-lg font-semibold mb-4" style="color: var(--dark-text-primary);">Quick Actions</h3>
                        <div class="space-y-3">
                            <a href="/" class="quick-action-btn block w-full text-left px-4 py-3 rounded-lg">
                                <i class="fas fa-plus-circle mr-2"></i> New Scan
                            </a>
                            <a href="/advanced_analysis" class="quick-action-btn block w-full text-left px-4 py-3 rounded-lg">
                                <i class="fas fa-shield-alt mr-2"></i> Advanced Analysis
                            </a>
                            <a href="#" class="quick-action-btn block w-full text-left px-4 py-3 rounded-lg">
                                <i class="fas fa-cog mr-2"></i> Settings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>
    
    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA7aO-t7jtiYz7ejFUSKpqs5lmtCLBxxXQ",
            authDomain: "phishgaurdai-e8d89.firebaseapp.com",
            projectId: "phishgaurdai-e8d89",
            storageBucket: "phishgaurdai-e8d89.firebasestorage.app",
            messagingSenderId: "746329814999",
            appId: "1:746329814999:web:f8f0f71e4c84eb655d7d92"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Chart instance
        let threatChart;

        // DOM Elements
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const sidebar = document.querySelector('.sidebar');
        
        // Toggle mobile sidebar
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('hidden');
                sidebarOverlay.classList.toggle('hidden');
            });
        }
        
        // Close sidebar when clicking overlay
        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.add('hidden');
                sidebarOverlay.classList.add('hidden');
            });
        }

        // Logout handler
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = '/';
            }).catch(error => {
                console.error('Logout error:', error);
            });
        });

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in, load their analysis history
                loadAnalysisHistory(user.uid);
            } else {
                // No user is signed in, redirect to home
                window.location.href = '/';
            }
        });

        // Format date to relative time (e.g., "2 hours ago")
        function formatRelativeTime(timestamp) {
            const seconds = Math.floor((new Date() - timestamp) / 1000);
            let interval = Math.floor(seconds / 31536000);
            
            if (interval > 1) return `${interval} years ago`;
            if (interval === 1) return '1 year ago';
            
            interval = Math.floor(seconds / 2592000);
            if (interval > 1) return `${interval} months ago`;
            if (interval === 1) return '1 month ago';
            
            interval = Math.floor(seconds / 86400);
            if (interval > 1) return `${interval} days ago`;
            if (interval === 1) return 'yesterday';
            
            interval = Math.floor(seconds / 3600);
            if (interval > 1) return `${interval} hours ago`;
            if (interval === 1) return '1 hour ago';
            
            interval = Math.floor(seconds / 60);
            if (interval > 1) return `${interval} minutes ago`;
            if (interval === 1) return '1 minute ago';
            
            return 'just now';
        }

        // Load analysis history
        function loadAnalysisHistory(userId) {
            const historyContainer = document.getElementById('analysis-history');
            
            // Initialize stats counters
            let stats = {
                total: 0,
                safe: 0,
                threats: 0,
                suspicious: 0
            };
            
            // Initialize chart data
            const chartData = {
                labels: ['Safe', 'Malicious', 'Suspicious'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                    borderWidth: 0,
                    borderRadius: 4
                }]
            };
            
            // Initialize chart with dark theme
            const ctx = document.getElementById('threatChart').getContext('2d');
            threatChart = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                color: '#94a3b8',
                                font: {
                                    family: 'Inter, sans-serif',
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        }
                    }
                }
            });

            // Show loading state
            historyContainer.innerHTML = `
                <div class="text-center py-8" style="color: var(--dark-text-muted);">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Loading scan history...</p>
                </div>`;

            // Query all scans for stats, but limit display to last 10
            db.collection('analysis_history')
                .where('userId', '==', userId)
                .orderBy('timestamp', 'desc')
                .get()
                .then(allScansSnapshot => {
                    // Process all scans for stats
                    allScansSnapshot.forEach(doc => {
                        const data = doc.data();
                        // Determine if the result is malicious
                        const isMalicious = (data.result === 'Malicious' || data.result === 'Phishing' || 
                                          (data.metadata && (data.metadata.prob_malicious || 0) > 0.7));
                        
                        // Determine if the result is suspicious (medium confidence of being malicious)
                        const isSuspicious = !isMalicious && data.metadata && 
                                          ((data.metadata.prob_malicious || data.metadata.probability || 0) > 0.4 && 
                                           (data.metadata.prob_malicious || data.metadata.probability || 0) <= 0.7);
                        
                        // Update stats from all scans
                        stats.total++;
                        if (isMalicious) {
                            stats.threats++;
                        } else if (isSuspicious) {
                            stats.suspicious++;
                        } else {
                            // If not malicious or suspicious, and has a benign probability, count as safe
                            const isBenign = data.result === 'Benign' || 
                                          (data.metadata && 
                                           (data.metadata.prob_benign || 1 - (data.metadata.prob_malicious || 0)) > 0.6);
                            if (isBenign) {
                                stats.safe++;
                            } else {
                                // Default to safe if we can't determine otherwise
                                stats.safe++;
                            }
                        }
                    });
                    
                    // Now get just the last 10 for display
                    return db.collection('analysis_history')
                        .where('userId', '==', userId)
                        .orderBy('timestamp', 'desc')
                        .limit(10)
                        .get();
                })
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        historyContainer.innerHTML = `
                            <div class="text-center py-8" style="color: var(--dark-text-muted);">
                                <i class="fas fa-inbox text-3xl mb-3 opacity-50"></i>
                                <p>No scan history found.</p>
                                <a href="/" class="mt-4 inline-block px-4 py-2 rounded-md transition-colors" style="background: linear-gradient(135deg, var(--primary-500), var(--primary-600)); color: white;">
                                    Run your first scan
                                </a>
                            </div>`;
                        return;
                    }
                    
                    let historyHtml = `
                        <div class="grid grid-cols-1 gap-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold" style="color: var(--dark-text-primary);">Recent Scans</h3>
                                <div class="flex space-x-2">
                                    <span class="badge" style="background: linear-gradient(135deg, var(--success-500), var(--success-600)); color: white;">
                                        <i class="fas fa-shield-alt mr-1"></i> Safe: ${stats.safe}
                                    </span>
                                    <span class="badge" style="background: linear-gradient(135deg, var(--warning-500), var(--warning-600)); color: white;">
                                        <i class="fas fa-exclamation-circle mr-1"></i> Suspicious: ${stats.suspicious}
                                    </span>
                                    <span class="badge" style="background: linear-gradient(135deg, var(--danger-500), var(--danger-600)); color: white;">
                                        <i class="fas fa-exclamation-triangle mr-1"></i> Malicious: ${stats.threats}
                                    </span>
                                </div>
                            </div>`;
                    
                    querySnapshot.forEach((doc, index) => {
                        const data = doc.data();
                        // Match the same classification logic as in stats calculation
                        const isMalicious = (data.result === 'Malicious' || data.result === 'Phishing' || 
                                          (data.metadata && (data.metadata.prob_malicious || 0) > 0.7));
                        
                        const isSuspicious = !isMalicious && data.metadata && 
                                          ((data.metadata.prob_malicious || data.metadata.probability || 0) > 0.4 && 
                                           (data.metadata.prob_malicious || data.metadata.probability || 0) <= 0.7);
                        
                        const timestamp = data.timestamp?.toDate ? data.timestamp.toDate() : new Date();
                        const formattedTime = formatRelativeTime(timestamp);
                        const probability = data.metadata ? 
                            (data.metadata.prob_malicious || data.metadata.probability || 0) * 100 : 0;
                        
                        // Status configuration with dark theme
                        let statusConfig = {
                            class: 'badge',
                            style: 'background: linear-gradient(135deg, var(--success-500), var(--success-600)); color: white;',
                            text: 'Safe',
                            icon: 'check-circle',
                            border: 'benign',
                            bg: 'rgba(16, 185, 129, 0.1)',
                            progress: 'var(--success-500)'
                        };
                        
                        if (isMalicious) {
                            statusConfig = {
                                class: 'badge',
                                style: 'background: linear-gradient(135deg, var(--danger-500), var(--danger-600)); color: white;',
                                text: 'Malicious',
                                icon: 'exclamation-triangle',
                                border: 'malicious',
                                bg: 'rgba(239, 68, 68, 0.1)',
                                progress: 'var(--danger-500)'
                            };
                        } else if (isSuspicious) {
                            statusConfig = {
                                class: 'badge',
                                style: 'background: linear-gradient(135deg, var(--warning-500), var(--warning-600)); color: white;',
                                text: 'Suspicious',
                                icon: 'exclamation-circle',
                                border: 'border-yellow-200',
                                bg: 'rgba(245, 158, 11, 0.1)',
                                progress: 'var(--warning-500)'
                            };
                        }
                        
                        // Format content snippet
                        let inputSnippet = data.inputSnippet || '';
                        const isLongText = inputSnippet.length > 100;
                        const displaySnippet = isLongText ? inputSnippet.substring(0, 100) + '...' : inputSnippet;
                        
                        // Create history item with animation and dark theme
                        historyHtml += `
                            <div class="history-item ${statusConfig.border}" style="background: ${statusConfig.bg}; border-radius: 0.75rem;">
                                <div class="p-4">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center mb-2 flex-wrap gap-2">
                                                <span class="${statusConfig.class}" style="${statusConfig.style}">
                                                    <i class="fas fa-${statusConfig.icon} mr-1.5"></i> ${statusConfig.text}
                                                </span>
                                                <span class="text-xs" style="color: var(--dark-text-muted);">
                                                    <i class="far fa-clock mr-1"></i>${formattedTime}
                                                </span>
                                                ${data.scanType ? `
                                                    <span class="text-xs" style="color: var(--dark-text-muted);">
                                                        <i class="fas fa-${data.scanType === 'email' ? 'envelope' : 'link'} mr-1"></i>${data.scanType}
                                                    </span>
                                                ` : ''}
                                            </div>
                                            
                                            <p class="text-sm font-medium mb-2 break-words" style="color: var(--dark-text-primary);">
                                                ${displaySnippet}
                                                ${isLongText ? `
                                                    <button onclick="this.previousSibling.textContent = this.previousSibling.textContent.endsWith('...') ? ${JSON.stringify(inputSnippet)} : ${JSON.stringify(displaySnippet)}; this.textContent = this.previousSibling.textContent.endsWith('...') ? 'Show more' : 'Show less';" 
                                                        class="text-xs ml-1 focus:outline-none" style="color: var(--primary-500);">
                                                        Show more
                                                    </button>
                                                ` : ''}
                                            </p>
                                            
                                            ${probability > 0 ? `
                                                <div class="mt-3">
                                                    <div class="flex justify-between text-xs mb-1" style="color: var(--dark-text-muted);">
                                                        <span>${isMalicious ? 'Threat Level' : 'Confidence'}</span>
                                                        <span class="font-medium">${probability.toFixed(1)}%</span>
                                                    </div>
                                                    <div class="w-full rounded-full h-2" style="background: var(--dark-bg-tertiary);">
                                                        <div class="h-2 rounded-full transition-all duration-1000 ease-out" 
                                                             style="width: ${Math.min(100, probability)}%; background: ${statusConfig.progress};">
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <div class="ml-4 flex-shrink-0">
                                            <button class="focus:outline-none" style="color: var(--dark-text-muted);"
                                                    onclick="this.closest('.history-item').classList.toggle('h-auto')">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3 flex items-center justify-between text-xs" style="color: var(--dark-text-muted);">
                                        <div class="flex space-x-2">
                                            <span class="inline-flex items-center">
                                                <i class="far fa-calendar-alt mr-1"></i>
                                                ${timestamp.toLocaleDateString()}
                                            </span>
                                            <span class="inline-flex items-center">
                                                <i class="far fa-clock mr-1"></i>
                                                ${timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                            </span>
                                        </div>
                                        <button class="text-sm font-medium focus:outline-none" style="color: var(--primary-500);"
                                                onclick="window.location.href='/?url=${encodeURIComponent(data.inputSnippet || '')}'">
                                            Scan Again
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                    });
                    
                    // Close the grid div
                    historyHtml += '</div>'; // Close grid container
                    
                    // Update UI with history and stats
                    historyContainer.innerHTML = historyHtml || `
                        <div class="text-center py-12">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-4" style="background: linear-gradient(135deg, var(--primary-500), var(--primary-600)); color: white;">
                                <i class="fas fa-inbox text-2xl"></i>
                            </div>
                            <h4 class="text-lg font-medium mb-1" style="color: var(--dark-text-primary);">No scan history found</h4>
                            <p class="mb-6" style="color: var(--dark-text-muted);">Start by scanning your first URL or email</p>
                            <a href="/" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" style="background: linear-gradient(135deg, var(--primary-500), var(--primary-600));">
                                <i class="fas fa-plus-circle mr-2"></i> New Scan
                            </a>
                        </div>`;
                    
                    // Add animation to history items
                    const historyItems = historyContainer.querySelectorAll('.history-item');
                    historyItems.forEach((item, index) => {
                        item.style.opacity = '0';
                        item.style.transform = 'translateY(20px)';
                        item.style.transition = `opacity 0.3s ease-out ${index * 0.1}s, transform 0.3s ease-out ${index * 0.1}s`;
                        
                        // Trigger reflow
                        void item.offsetWidth;
                        
                        item.style.opacity = '1';
                        item.style.transform = 'translateY(0)';
                    });
                    
                    // Update stats cards with animation
                    const animateValue = (elementId, target) => {
                        const element = document.getElementById(elementId);
                        const current = parseInt(element.textContent) || 0;
                        const duration = 1000; // 1 second
                        const step = (target - current) / (duration / 16); // 60fps
                        let currentValue = current;
                        
                        const updateCounter = () => {
                            currentValue += step;
                            if ((step > 0 && currentValue >= target) || (step < 0 && currentValue <= target)) {
                                element.textContent = target;
                                return;
                            }
                            element.textContent = Math.round(currentValue);
                            requestAnimationFrame(updateCounter);
                        };
                        
                        updateCounter();
                    };
                    
                    // Animate the counter updates
                    animateValue('total-scans', stats.total);
                    animateValue('safe-items', stats.safe);
                    animateValue('threats-detected', stats.threats);
                    animateValue('suspicious-items', stats.suspicious);
                    
                    // Update chart with animation
                    const chartData = [stats.safe, stats.threats, stats.suspicious];
                    const animateChart = () => {
                        const currentData = threatChart.data.datasets[0].data;
                        let allDone = true;
                        
                        currentData.forEach((value, index) => {
                            if (value < chartData[index]) {
                                currentData[index] = Math.ceil(value + (chartData[index] - value) * 0.1);
                                allDone = false;
                            } else if (value > chartData[index]) {
                                currentData[index] = Math.floor(value - (value - chartData[index]) * 0.1);
                                allDone = false;
                            }
                        });
                        
                        threatChart.update();
                        
                        if (!allDone) {
                            requestAnimationFrame(animateChart);
                        }
                    };
                    
                    animateChart();
                    
                }).catch(error => {
                    console.error("Error loading history:", error);
                    historyContainer.innerHTML = `
                        <div class="p-4 rounded-lg" style="background: rgba(239, 68, 68, 0.1); color: var(--danger-500); border: 1px solid var(--danger-500);">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium">
                                        Error loading scan history. Please try again later.
                                    </p>
                                </div>
                            </div>
                        </div>`;
                });
        }
        
        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>
</body>
</html>