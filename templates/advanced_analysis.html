<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhishGuard AI - Advanced Analysis</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      /* Color System */
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-500: #3b82f6;
      --primary-600: #2563eb;
      --primary-700: #1d4ed8;
      --primary-900: #1e3a8a;
      
      --success-50: #f0fdf4;
      --success-500: #10b981;
      --success-600: #059669;
      
      --danger-50: #fef2f2;
      --danger-500: #ef4444;
      --danger-600: #dc2626;
      
      --warning-50: #fffbeb;
      --warning-500: #f59e0b;
      --warning-600: #d97706;
      
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      
      /* Dark Theme */
      --dark-bg-primary: #0f172a;
      --dark-bg-secondary: #1e293b;
      --dark-bg-tertiary: #334155;
      --dark-text-primary: #f8fafc;
      --dark-text-secondary: #e2e8f0;
      --dark-text-muted: #94a3b8;
      --dark-border: #334155;
      --dark-border-hover: #475569;
      
      /* Spacing */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;
      --space-16: 4rem;
      
      /* Border Radius */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      
      /* Transitions */
      --transition-fast: 150ms ease-in-out;
      --transition-normal: 250ms ease-in-out;
      --transition-slow: 350ms ease-in-out;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, var(--dark-bg-primary) 0%, #1a202c 100%);
      min-height: 100vh;
      padding: 0;
      color: var(--dark-text-primary);
      line-height: 1.6;
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .header {
      background: linear-gradient(135deg, var(--dark-bg-secondary) 0%, var(--dark-bg-primary) 100%);
      border-bottom: 1px solid var(--dark-border);
      padding: var(--space-12) var(--space-4);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
      pointer-events: none;
    }
    
    .header-content {
      position: relative;
      z-index: 1;
    }
    
    .header h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 700;
      margin-bottom: var(--space-3);
      color: var(--dark-text-primary);
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--dark-text-primary) 0%, var(--primary-500) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .header p {
      font-size: 1.125rem;
      color: var(--dark-text-muted);
      font-weight: 400;
      margin-bottom: var(--space-8);
    }
    
    .nav-links {
      display: flex;
      gap: var(--space-4);
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-6);
      border-radius: var(--radius-lg);
      font-weight: 500;
      font-size: 0.875rem;
      text-decoration: none;
      transition: all var(--transition-normal);
      border: none;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left var(--transition-slow);
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      color: white;
      box-shadow: var(--shadow-md);
      padding: 12px 24px;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn-secondary {
      background: var(--dark-bg-tertiary);
      color: var(--dark-text-secondary);
      border: 1px solid var(--dark-border);
    }
    
    .btn-secondary:hover {
      background: var(--dark-border-hover);
      border-color: var(--dark-border-hover);
      transform: translateY(-1px);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: var(--space-12) var(--space-4);
    }
    
    .card {
      background: var(--dark-bg-secondary);
      border: 1px solid var(--dark-border);
      border-radius: var(--radius-2xl);
      padding: var(--space-8);
      margin-bottom: var(--space-8);
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--primary-500), transparent);
      opacity: 0;
      transition: opacity var(--transition-normal);
    }
    
    .card:hover {
      border-color: var(--dark-border-hover);
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    .card h2 {
      font-size: 1.5rem;
      margin-bottom: var(--space-6);
      color: var(--dark-text-primary);
      font-weight: 600;
      letter-spacing: -0.02em;
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .api-status {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--space-4);
      margin-bottom: var(--space-8);
    }
    
    .api-item {
      padding: var(--space-6);
      border-radius: var(--radius-lg);
      border: 2px solid var(--dark-border);
      background: var(--dark-bg-primary);
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
    }
    
    .api-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      transition: all var(--transition-normal);
    }
    
    .api-item.configured {
      border-color: var(--success-500);
      background: rgba(16, 185, 129, 0.05);
    }
    
    .api-item.configured::before {
      background: linear-gradient(90deg, var(--success-500), var(--success-600));
    }
    
    .api-item.not-configured {
      border-color: var(--warning-500);
      background: rgba(245, 158, 11, 0.05);
    }
    
    .api-item.not-configured::before {
      background: linear-gradient(90deg, var(--warning-500), var(--warning-600));
    }
    
    .api-item strong {
      display: block;
      font-weight: 600;
      color: var(--dark-text-primary);
      margin-bottom: var(--space-2);
    }
    
    .api-item span {
      color: var(--dark-text-muted);
      font-size: 0.875rem;
    }
    
    .tabs {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-8);
      border-bottom: 2px solid var(--dark-border);
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .tabs::-webkit-scrollbar {
      display: none;
    }
    
    .tab {
      padding: var(--space-4) var(--space-6);
      cursor: pointer;
      border: none;
      background: none;
      font-size: 1rem;
      font-weight: 600;
      color: var(--dark-text-muted);
      transition: all var(--transition-normal);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      position: relative;
      white-space: nowrap;
    }
    
    .tab:hover {
      color: var(--dark-text-secondary);
      background: var(--dark-bg-tertiary);
    }
    
    .tab.active {
      color: var(--primary-500);
      background: var(--dark-bg-primary);
      border-bottom: 3px solid var(--primary-500);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: var(--space-6);
    }
    
    .form-label {
      display: block;
      margin-bottom: var(--space-2);
      font-weight: 500;
      color: var(--dark-text-secondary);
      font-size: 0.875rem;
    }
    
    input[type="text"], textarea, select {
      width: 100%;
      padding: var(--space-4);
      border: 2px solid var(--dark-border);
      border-radius: var(--radius-lg);
      font-size: 1rem;
      font-family: inherit;
      background: var(--dark-bg-primary);
      color: var(--dark-text-primary);
      transition: all var(--transition-normal);
    }
    
    input[type="text"]:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary-500);
      background: var(--dark-bg-secondary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }
    
    input[type="text"]::placeholder, textarea::placeholder {
      color: var(--dark-text-muted);
    }
    
    textarea {
      min-height: 150px;
      resize: vertical;
      line-height: 1.6;
    }
    
    .form-button {
      padding: var(--space-4) var(--space-6);
      border: none;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
    }
    
    .form-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left var(--transition-slow);
    }
    
    .form-button:hover::before {
      left: 100%;
    }
    
    .form-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .form-button:active {
      transform: translateY(0);
    }
    
    .result {
      margin-top: var(--space-8);
      padding: var(--space-6);
      border-radius: var(--radius-xl);
      background: var(--dark-bg-primary);
      border: 1px solid var(--dark-border);
      animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .result::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-500), var(--success-500));
      opacity: 0.8;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .result-section {
      margin-bottom: var(--space-6);
      padding: var(--space-6);
      background: var(--dark-bg-secondary);
      border-radius: var(--radius-lg);
      border-left: 4px solid var(--primary-500);
      transition: all var(--transition-normal);
    }
    
    .result-section:hover {
      border-left-color: var(--primary-600);
      transform: translateX(4px);
    }
    
    .result-section h3 {
      margin-bottom: var(--space-3);
      color: var(--dark-text-primary);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    
    .verdict-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-lg);
      font-weight: 700;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: var(--space-2) 0;
      box-shadow: var(--shadow-sm);
    }
    
    .verdict-malicious {
      background: linear-gradient(135deg, var(--danger-500) 0%, var(--danger-600) 100%);
      color: white;
    }
    
    .verdict-clean {
      background: linear-gradient(135deg, var(--success-500) 0%, var(--success-600) 100%);
      color: white;
    }
    
    .verdict-unknown {
      background: var(--dark-bg-tertiary);
      color: var(--dark-text-muted);
      border: 1px solid var(--dark-border);
    }
    
    .loading {
      text-align: center;
      padding: var(--space-12);
      color: var(--primary-500);
      font-weight: 600;
    }
    
    .spinner {
      border: 3px solid var(--dark-bg-tertiary);
      border-top: 3px solid var(--primary-500);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-6);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 1.125rem;
      color: var(--dark-text-secondary);
    }
    
    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-500);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      border-radius: var(--radius-lg);
      color: var(--dark-text-secondary);
    }
    
    .info-box strong {
      color: var(--primary-500);
    }
    
    .warning-box {
      background: rgba(245, 158, 11, 0.1);
      border-left: 4px solid var(--warning-500);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      border-radius: var(--radius-lg);
      color: var(--dark-text-secondary);
    }
    
    .warning-box strong {
      color: var(--warning-500);
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }
    
    @media (max-width: 768px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
      
      .container {
        padding: var(--space-8) var(--space-4);
      }
      
      .header {
        padding: var(--space-8) var(--space-4);
      }
      
      .nav-links {
        flex-direction: column;
        align-items: center;
      }
      
      .tabs {
        flex-direction: column;
        gap: var(--space-1);
      }
      
      .tab {
        border-radius: var(--radius-lg);
        border-bottom: none;
      }
      
      .tab.active {
        border-bottom: none;
        background: var(--primary-500);
        color: white;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1><i class="fas fa-microscope"></i> Advanced Threat Analysis</h1>
      <p>Deep analysis using external security APIs</p>
      <div class="nav-links">
        <a href="/" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Back to Main
        </a>
        <a href="#api-config" class="btn btn-primary">
          <i class="fas fa-cog"></i>
          API Configuration
        </a>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- API Status Card -->
    <div class="card">
      <h2><i class="fas fa-satellite-dish"></i> API Status</h2>
      <div class="api-status">
        <div class="api-item {% if api_status.virustotal %}configured{% else %}not-configured{% endif %}">
          <strong><i class="fas fa-shield-virus"></i> VirusTotal</strong>
          <span>{% if api_status.virustotal %}<i class="fas fa-check-circle text-green"></i> Configured{% else %}<i class="fas fa-exclamation-triangle text-yellow"></i> Not Configured{% endif %}</span>
        </div>
        <div class="api-item {% if api_status.urlscan %}configured{% else %}not-configured{% endif %}">
          <strong><i class="fas fa-search"></i> URLScan.io</strong>
          <span>{% if api_status.urlscan %}<i class="fas fa-check-circle text-green"></i> Configured{% else %}<i class="fas fa-exclamation-triangle text-yellow"></i> Not Configured{% endif %}</span>
        </div>
        <div class="api-item {% if api_status.google_safe_browsing %}configured{% else %}not-configured{% endif %}">
          <strong><i class="fas fa-google"></i> Google Safe Browsing</strong>
          <span>{% if api_status.google_safe_browsing %}<i class="fas fa-check-circle text-green"></i> Configured{% else %}<i class="fas fa-exclamation-triangle text-yellow"></i> Not Configured{% endif %}</span>
        </div>
        <div class="api-item {% if api_status.abuseipdb %}configured{% else %}not-configured{% endif %}">
          <strong><i class="fas fa-ban"></i> AbuseIPDB</strong>
          <span>{% if api_status.abuseipdb %}<i class="fas fa-check-circle text-green"></i> Configured{% else %}<i class="fas fa-exclamation-triangle text-yellow"></i> Not Configured{% endif %}</span>
        </div>
        <div class="api-item configured">
          <strong><i class="fas fa-fish"></i> PhishTank</strong>
          <span><i class="fas fa-check-circle text-green"></i> Available</span>
        </div>
        <div class="api-item {% if api_status.whois %}configured{% else %}not-configured{% endif %}">
          <strong><i class="fas fa-globe"></i> WHOIS</strong>
          <span>{% if api_status.whois %}<i class="fas fa-check-circle text-green"></i> Configured{% else %}<i class="fas fa-exclamation-triangle text-yellow"></i> Not Configured{% endif %}</span>
        </div>
      </div>
      
      <div class="info-box">
        <strong><i class="fas fa-info-circle"></i> Note:</strong> Configure API keys below to enable deep analysis. Free tiers available for all services.
      </div>
    </div>

    <!-- Analysis Tabs -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('email')">
          <i class="fas fa-envelope"></i> Email Deep Analysis
        </button>
        <button class="tab" onclick="switchTab('url')">
          <i class="fas fa-link"></i> URL Analysis
        </button>
        <button class="tab" onclick="switchTab('ip')">
          <i class="fas fa-network-wired"></i> IP Analysis
        </button>
        <button class="tab" onclick="switchTab('domain')">
          <i class="fas fa-building"></i> Domain Analysis
        </button>
      </div>

      <!-- Email Deep Analysis Tab -->
      <div id="email-tab" class="tab-content active">
        <h2><i class="fas fa-envelope"></i> Email Deep Analysis</h2>
        <div class="info-box">
          <strong><i class="fas fa-info-circle"></i> Instructions:</strong> Paste an email to extract and analyze all URLs, IPs, and domains using multiple security APIs.
        </div>
        <form id="emailDeepForm" enctype="multipart/form-data">
          <div class="form-group">
            <label class="form-label" for="email">Email Content</label>
            <textarea name="email" id="email" rows="5" placeholder="Paste email content here..."></textarea>
          </div>
          <div style="text-align: center; margin: var(--space-4) 0; color: var(--dark-text-muted); font-weight: 500;">
            <i class="fas fa-arrows-alt-v"></i> OR <i class="fas fa-arrows-alt-v"></i>
          </div>
          <div class="form-group">
            <label class="form-label" for="emailFile">Upload .eml file</label>
            <input type="file" name="file" id="emailFile" accept=".eml,.txt">
          </div>
          <button type="submit" class="form-button">
            <i class="fas fa-search"></i>
            Analyze Email
          </button>
        </form>
        <div id="emailDeepResult"></div>
      </div>

      <!-- URL Analysis Tab -->
      <div id="url-tab" class="tab-content">
        <div class="analysis-header">
          <div class="header-icon">
            <i class="fas fa-link"></i>
          </div>
          <div class="header-text">
            <h2>URL Deep Analysis</h2>
            <p class="subtitle">Comprehensive security analysis of web addresses</p>
          </div>
        </div>
        
        <div class="info-box glass">
          <div class="info-icon">
            <i class="fas fa-info-circle"></i>
          </div>
          <div class="info-content">
            <h4>How It Works</h4>
            <p>Enter a URL to analyze it across multiple threat intelligence services including VirusTotal, URLScan.io, Google Safe Browsing, and PhishTank. Our system will provide a comprehensive security assessment.</p>
          </div>
        </div>
        
        <div class="card glass form-card">
          <form id="urlDeepForm" class="url-analysis-form">
            <div class="form-group">
              <div class="input-group">
                <span class="input-icon"><i class="fas fa-link"></i></span>
                <input type="text" 
                       name="url" 
                       id="url" 
                       placeholder="https://example.com" 
                       required
                       autocomplete="off"
                       class="form-control">
                <button type="submit" class="btn-primary">
                  <i class="fas fa-search"></i>
                  Analyze URL
                </button>
              </div>
              <div class="form-hint">
                <i class="fas fa-lightbulb"></i> Enter a complete URL including http:// or https://
              </div>
            </div>
          </form>
        </div>
        
        <div id="urlDeepResult" class="results-container"></div>
      </div>

      <!-- IP Analysis Tab -->
      <div id="ip-tab" class="tab-content">
        <h2><i class="fas fa-network-wired"></i> IP Address Analysis</h2>
        <div class="info-box">
          <strong><i class="fas fa-info-circle"></i> Analysis:</strong> Check IP reputation using VirusTotal and AbuseIPDB.
        </div>
        <form id="ipForm">
          <div class="form-group">
            <label class="form-label" for="ip">IP Address</label>
            <input type="text" name="ip" id="ip" placeholder="192.168.1.1" required>
          </div>
          <button type="submit" class="form-button">
            <i class="fas fa-search"></i>
            Analyze IP
          </button>
        </form>
        <div id="ipResult"></div>
      </div>

      <!-- Domain Analysis Tab -->
      <div id="domain-tab" class="tab-content">
        <h2><i class="fas fa-building"></i> Domain Analysis</h2>
        <div class="info-box">
          <strong><i class="fas fa-info-circle"></i> Analysis:</strong> Analyze domain reputation and WHOIS information.
        </div>
        <form id="domainForm">
          <div class="form-group">
            <label class="form-label" for="domain">Domain Name</label>
            <input type="text" name="domain" id="domain" placeholder="example.com" required>
          </div>
          <button type="submit" class="form-button">
            <i class="fas fa-search"></i>
            Analyze Domain
          </button>
        </form>
        <div id="domainResult"></div>
      </div>
    </div>

    <!-- API Configuration Card -->
    <div class="card" id="api-config">
      <h2><i class="fas fa-cog"></i> API Configuration</h2>
      <div class="warning-box">
        <strong><i class="fas fa-exclamation-triangle"></i> Security Note:</strong> API keys are stored in memory only and will be lost when the server restarts. For production, use environment variables.
      </div>
      
      <div class="info-box">
        <strong><i class="fas fa-key"></i> Get Free API Keys:</strong><br>
        • <a href="https://www.virustotal.com/gui/join-us" target="_blank" style="color: var(--primary-500);">VirusTotal</a> (500 requests/day)<br>
        • <a href="https://urlscan.io/user/signup" target="_blank" style="color: var(--primary-500);">URLScan.io</a> (100 requests/day)<br>
        • <a href="https://developers.google.com/safe-browsing" target="_blank" style="color: var(--primary-500);">Google Safe Browsing</a> (10,000 requests/day)<br>
        • <a href="https://www.abuseipdb.com/register" target="_blank" style="color: var(--primary-500);">AbuseIPDB</a> (1,000 requests/day)<br>
        • <a href="https://whoisxmlapi.com/" target="_blank" style="color: var(--primary-500);">WHOIS API</a> (Free tier available)
      </div>

      <form id="apiConfigForm">
        <div class="grid-2">
          <div class="form-group">
            <label class="form-label" for="service">Service</label>
            <select name="service" id="service">
              <option value="virustotal">VirusTotal</option>
              <option value="urlscan">URLScan.io</option>
              <option value="google_safe_browsing">Google Safe Browsing</option>
              <option value="abuseipdb">AbuseIPDB</option>
              <option value="whois">WHOIS API</option>
              <option value="phishtank">PhishTank (Optional)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="api_key">API Key</label>
            <input type="text" name="api_key" id="api_key" placeholder="Enter API key" required>
          </div>
        </div>
        <button type="submit" class="form-button">
          <i class="fas fa-save"></i>
          Save API Key
        </button>
      </form>
      <div id="apiConfigResult"></div>
    </div>
  </div>

  <script>
    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    // Email Deep Analysis
    document.getElementById('emailDeepForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const resultDiv = document.getElementById('emailDeepResult');
      const form = this;
      
      // Validate that either text or file is provided
      const emailText = form.email.value.trim();
      const fileInput = form.file;
      
      if (!emailText && (!fileInput || !fileInput.files || fileInput.files.length === 0)) {
        resultDiv.innerHTML = '<div class="warning-box">Please provide either email text or upload a file.</div>';
        return;
      }
      
      resultDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div class="loading-text">Analyzing email components... This may take 30-60 seconds...</div>
        </div>
      `;
      
      try {
        const formData = new FormData(form);
        // If no file is selected but text is provided, ensure it's sent
        if (fileInput.files.length === 0 && emailText) {
          formData.set('email', emailText);
        }
        
        const response = await fetch('/analyze_email_deep', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          const error = await response.text();
          throw new Error(`Server error: ${response.status} - ${error}`);
        }
        
        const data = await response.json();
        resultDiv.innerHTML = formatEmailDeepResult(data);
      } catch (error) {
        console.error('Error analyzing email:', error);
        resultDiv.innerHTML = '<div class="result"><div class="warning-box">Error: ' + error.message + '</div></div>';
      }
    });

    // URL Deep Analysis
    document.getElementById('urlDeepForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const resultDiv = document.getElementById('urlDeepResult');
      resultDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div class="loading-text">Analyzing URL... This may take 20-30 seconds...</div>
        </div>
      `;
      
      try {
        const formData = new FormData(this);
        const response = await fetch('/analyze_url_deep', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        resultDiv.innerHTML = formatURLResult(data);
      } catch (error) {
        resultDiv.innerHTML = '<div class="result"><div class="warning-box">Error: ' + error.message + '</div></div>';
      }
    });

    // IP Analysis
    document.getElementById('ipForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const resultDiv = document.getElementById('ipResult');
      resultDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div class="loading-text">Analyzing IP address...</div>
        </div>
      `;
      
      try {
        const formData = new FormData(this);
        const response = await fetch('/analyze_ip', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        resultDiv.innerHTML = formatIPResult(data);
      } catch (error) {
        resultDiv.innerHTML = '<div class="result"><div class="warning-box">Error: ' + error.message + '</div></div>';
      }
    });

    // Domain Analysis
    document.getElementById('domainForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const resultDiv = document.getElementById('domainResult');
      resultDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div class="loading-text">Analyzing domain...</div>
        </div>
      `;
      
      try {
        const formData = new FormData(this);
        const response = await fetch('/analyze_domain', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        resultDiv.innerHTML = formatDomainResult(data);
      } catch (error) {
        resultDiv.innerHTML = '<div class="result"><div class="warning-box">Error: ' + error.message + '</div></div>';
      }
    });

    // API Configuration
    document.getElementById('apiConfigForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const resultDiv = document.getElementById('apiConfigResult');
      
      try {
        const formData = new FormData(this);
        const response = await fetch('/api_config', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        if (data.success) {
          resultDiv.innerHTML = '<div class="result"><div class="info-box">✅ ' + data.message + '</div></div>';
          setTimeout(() => location.reload(), 1500);
        } else {
          resultDiv.innerHTML = '<div class="result"><div class="warning-box">❌ ' + data.message + '</div></div>';
        }
      } catch (error) {
        resultDiv.innerHTML = '<div class="result"><div class="warning-box">Error: ' + error.message + '</div></div>';
      }
    });

    // Format functions
    function formatEmailDeepResult(data) {
      let html = '<div class="result">';
      
      // Check for errors first
      if (data.error) {
        html += `<div class="warning-box"><strong><i class="fas fa-exclamation-triangle"></i> Error:</strong> ${data.error}</div>`;
        html += '</div>';
        return html;
      }

      // Email Features
      if (data.email_features) {
        html += '<div class="result-section">';
        html += '<h3><i class="fas fa-envelope"></i> Email Overview</h3>';
        html += `<p>From Domain: <strong>${data.email_features.from_domain || 'N/A'}</strong></p>`;
        html += `<p>URLs Found: <strong>${data.email_features.num_urls || 0}</strong></p>`;
        html += `<p>IPs Found: <strong>${data.email_features.num_ips || 0}</strong></p>`;
        html += `<p>Domains Found: <strong>${data.email_features.num_domains || 0}</strong></p>`;
        html += '</div>';
      }
      
      // Process URLs
      if (data.urls && data.urls.length > 0) {
        html += '<div class="result-section">';
        html += '<h3><i class="fas fa-link"></i> URL Analysis Results</h3>';
        data.urls.forEach(item => {
          const isMalicious = item.verdict === 'malicious' || (item.is_malicious === true);
          const confidence = item.confidence || 0;
          
          html += `<div style="margin-bottom: var(--space-4); padding: var(--space-4); background: var(--dark-bg-primary); border-radius: var(--radius-lg); border: 1px solid var(--dark-border);">`;
          html += `<strong style="color: var(--dark-text-primary);">${item.url || 'Unknown URL'}</strong><br>`;
          
          if (item.error) {
            html += `<span class="verdict-badge verdict-unknown"><i class="fas fa-exclamation-triangle"></i> ERROR</span>`;
            html += `<p style="color: var(--danger-500); margin-top: var(--space-2);">${item.error}</p>`;
          } else {
            html += `<span class="verdict-badge verdict-${isMalicious ? 'malicious' : 'clean'}">`;
            html += `<i class="fas ${isMalicious ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>`;
            html += isMalicious ? 'MALICIOUS' : 'CLEAN';
            html += `</span>`;
            
            if (confidence > 0) {
              html += `<p style="color: var(--dark-text-secondary); margin-top: var(--space-2);">Confidence: <strong>${confidence}%</strong></p>`;
            }
            
            // Add any additional details if available
            if (item.threats && item.threats.length > 0) {
              html += '<div style="margin-top: var(--space-3); font-size: 0.9em; color: var(--dark-text-muted);">';
              html += '<strong>Threats detected:</strong><ul style="margin: var(--space-2) 0 0 var(--space-6);">';
              item.threats.forEach(threat => {
                html += `<li>${threat}</li>`;
              });
              html += '</ul></div>';
            }
          }
          
          html += `</div>`;
        });
        html += '</div>';
      }
      
      // Process IPs
      if (data.ips && data.ips.length > 0) {
        html += '<div class="result-section">';
        html += '<h3><i class="fas fa-network-wired"></i> IP Analysis Results</h3>';
        data.ips.forEach(item => {
          const isMalicious = item.verdict === 'malicious' || (item.is_malicious === true);
          
          html += `<div style="margin-bottom: var(--space-4); padding: var(--space-4); background: var(--dark-bg-primary); border-radius: var(--radius-lg); border: 1px solid var(--dark-border);">`;
          html += `<strong style="color: var(--dark-text-primary);">${item.ip || 'Unknown IP'}</strong><br>`;
          
          if (item.error) {
            html += `<span class="verdict-badge verdict-unknown"><i class="fas fa-exclamation-triangle"></i> ERROR</span>`;
            html += `<p style="color: var(--danger-500); margin-top: var(--space-2);">${item.error}</p>`;
          } else {
            html += `<span class="verdict-badge verdict-${isMalicious ? 'malicious' : 'clean'}">`;
            html += `<i class="fas ${isMalicious ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>`;
            html += isMalicious ? 'MALICIOUS' : 'CLEAN';
            html += `</span>`;
            
            // Add any additional details if available
            if (item.details) {
              html += '<div style="margin-top: var(--space-3); font-size: 0.9em; color: var(--dark-text-muted);">';
              for (const [key, value] of Object.entries(item.details)) {
                if (value) {
                  html += `<p><strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong> ${value}</p>`;
                }
              }
              html += '</div>';
            }
          }
          
          html += `</div>`;
        });
        html += '</div>';
      }
      
      // Process Domains
      if (data.domains && data.domains.length > 0) {
        html += '<div class="result-section">';
        html += '<h3><i class="fas fa-building"></i> Domain Analysis Results</h3>';
        data.domains.forEach(item => {
          const isMalicious = item.verdict === 'malicious' || (item.is_malicious === true);
          
          html += `<div style="margin-bottom: var(--space-4); padding: var(--space-4); background: var(--dark-bg-primary); border-radius: var(--radius-lg); border: 1px solid var(--dark-border);">`;
          html += `<strong style="color: var(--dark-text-primary);">${item.domain || 'Unknown Domain'}</strong><br>`;
          
          if (item.error) {
            html += `<span class="verdict-badge verdict-unknown"><i class="fas fa-exclamation-triangle"></i> ERROR</span>`;
            html += `<p style="color: var(--danger-500); margin-top: var(--space-2);">${item.error}</p>`;
          } else {
            html += `<span class="verdict-badge verdict-${isMalicious ? 'malicious' : 'clean'}">`;
            html += `<i class="fas ${isMalicious ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>`;
            html += isMalicious ? 'MALICIOUS' : 'CLEAN';
            html += `</span>`;
            
            // Add any additional details if available
            if (item.details) {
              html += '<div style="margin-top: var(--space-3); font-size: 0.9em; color: var(--dark-text-muted);">';
              for (const [key, value] of Object.entries(item.details)) {
                if (value) {
                  html += `<p><strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong> ${value}</p>`;
                }
              }
              html += '</div>';
            }
          }
          
          html += `</div>`;
        });
        html += '</div>';
      }
      
      html += '</div>';
      return html;
    }

    function formatURLResult(data) {
      // Handle error case first
      if (data.error) {
        return `
        <div class="result-card glass">
          <div class="result-header">
            <div class="result-icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="result-title">
              <h3>Error</h3>
              <p class="result-subtitle">${new Date().toLocaleString()}</p>
            </div>
          </div>
          <div class="result-body">
            <div class="warning-box">
              <i class="fas fa-exclamation-circle"></i>
              <strong>Error:</strong> ${data.error}
            </div>
          </div>
        </div>`;
      }

      // Determine if the URL is malicious based on available data
      let isMalicious = false;
      let confidence = 0;
      let maliciousSources = 0;
      let totalSources = 0;
      
      // Check VirusTotal results
      if (data.virustotal && data.virustotal.detection_ratio) {
        const [detected, total] = data.virustotal.detection_ratio.split('/').map(Number);
        maliciousSources += detected;
        totalSources += total || 1;
      }
      
      // Check URLScan results
      if (data.urlscan && data.urlscan.malicious) {
        maliciousSources += 1;
        totalSources += 1;
      }
      
      // Calculate confidence based on available sources
      if (totalSources > 0) {
        confidence = Math.round((maliciousSources / totalSources) * 100);
        isMalicious = maliciousSources > 0;
      }
      
      // Extract URL from the data or use a placeholder
      const url = data.url || 'Unknown URL';
      
      let html = `
      <div class="result-card glass">
        <div class="result-header ${isMalicious ? 'malicious' : 'clean'}">
          <div class="result-icon">
            <i class="fas ${isMalicious ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>
          </div>
          <div class="result-title">
            <h3>${url}</h3>
            <p class="result-subtitle">Analyzed ${new Date().toLocaleString()}</p>
          </div>
          <div class="verdict-badge ${isMalicious ? 'verdict-malicious' : 'verdict-clean'}">
            ${isMalicious ? 'MALICIOUS' : 'CLEAN'}
          </div>
        </div>
        
        <div class="result-body">
          <!-- Overall Verdict -->
          <div class="verdict-summary">
            <div class="verdict-metric">
              <span class="metric-label">Confidence</span>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${confidence}%; background: ${getConfidenceColor(confidence)};">
                  <span>${confidence}%</span>
                </div>
              </div>
            </div>
            <div class="verdict-metric">
              <span class="metric-label">Threat Score</span>
              <div class="threat-score ${getThreatLevel(confidence)}">
                ${getThreatLevelText(confidence)}
              </div>
            </div>
            <div class="verdict-metric">
              <span class="metric-label">Sources Flagged</span>
              <div class="sources-flagged">
                <span class="sources-count">${maliciousSources}/${totalSources}</span>
                <span class="sources-label">security sources</span>
              </div>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <!-- Service Results -->
          <div class="service-results">
            ${formatServiceResult('VirusTotal', data.virustotal, 'shield-virus', {
              'Malicious': data.virustotal?.malicious,
              'Suspicious': data.virustotal?.suspicious,
              'Harmless': data.virustotal?.harmless,
              'Undetected': data.virustotal?.undetected
            }, data.virustotal?.permalink)}
            
            ${formatServiceResult('URLScan.io', data.urlscan, 'search', {
              'Malicious': data.urlscan?.malicious ? 'Yes' : 'No',
              'Screenshot': data.urlscan?.screenshot ? 'Available' : 'Not available'
            }, data.urlscan?.report_url)}
            
            ${formatServiceResult('Google Safe Browsing', data.googlesafebrowsing, 'google', {
              'Threats Detected': data.googlesafebrowsing?.threats_found?.length || 0,
              'Status': data.googlesafebrowsing?.threats_found?.length ? 'Unsafe' : 'Safe'
            })}
            
            ${formatServiceResult('PhishTank', data.phishtank, 'fish', {
              'Phishing': data.phishtank?.in_database ? 'Detected' : 'Not Detected',
              'Verified': data.phishtank?.verified ? 'Yes' : 'No'
            }, data.phishtank?.details_url)}
          </div>
          
          ${data.urlscan?.screenshot ? `
          <div class="screenshot-preview">
            <h4><i class="fas fa-camera"></i> Website Preview</h4>
            <div class="screenshot-container">
              <img src="${data.urlscan.screenshot}" alt="Website Screenshot" class="screenshot">
              <div class="screenshot-overlay">
                <a href="${data.url}" target="_blank" class="btn-outline">
                  <i class="fas fa-external-link-alt"></i> Visit Site
                </a>
              </div>
            </div>
          </div>` : ''}
          
          <div class="result-footer">
            <div class="last-updated">
              <i class="fas fa-sync-alt"></i> Results update in 24 hours
            </div>
            <div class="report-actions">
              <button class="btn-text" onclick="downloadReport('${data.url}')">
                <i class="fas fa-download"></i> Download Report
              </button>
              <button class="btn-text" onclick="shareResults('${data.url}')">
                <i class="fas fa-share-alt"></i> Share
              </button>
            </div>
          </div>
        </div>
      </div>`;
      
      return html;
      
      // Helper function to format service results
      function formatServiceResult(name, service, icon, metrics, url) {
        if (!service) return '';
        
        // Check if the service has data in the expected format
        const hasData = service.available || 
                       (service.detection_ratio !== undefined) || 
                       (service.malicious !== undefined) ||
                       (service.threats_found !== undefined);
        
        if (!hasData) return '';
        
        let metricsHtml = '';
        for (const [label, value] of Object.entries(metrics)) {
          if (value !== undefined) {
            metricsHtml += `
            <div class="metric-item">
              <span class="metric-label">${label}</span>
              <span class="metric-value">${value}</span>
            </div>`;
          }
        }
        
        const reportLink = url ? `
        <a href="${url}" target="_blank" class="report-link">
          View Report <i class="fas fa-external-link-alt"></i>
        </a>` : '';
        
        return `
        <div class="service-card">
          <div class="service-header">
            <div class="service-icon">
              <i class="fas fa-${icon}"></i>
            </div>
            <h4>${name}</h4>
            ${reportLink}
          </div>
          <div class="service-metrics">
            ${metricsHtml}
          </div>
        </div>`;
      }
      
      function getConfidenceColor(confidence) {
        if (confidence > 70) return 'var(--danger-500)';
        if (confidence > 30) return 'var(--warning-500)';
        return 'var(--success-500)';
      }
      
      function getThreatLevel(confidence) {
        if (confidence > 70) return 'high';
        if (confidence > 30) return 'medium';
        return 'low';
      }
      
      function getThreatLevelText(confidence) {
        if (confidence > 70) return 'High Risk';
        if (confidence > 30) return 'Medium Risk';
        return 'Low Risk';
      }
    }

    function formatIPResult(data) {
      let html = '<div class="result">';
      html += '<div class="result-section">';
      html += '<h3><i class="fas fa-network-wired"></i> IP Analysis: ' + data.ip + '</h3>';
      
      const verdict = data.overall_verdict;
      html += `<span class="verdict-badge verdict-${verdict.is_malicious ? 'malicious' : 'clean'}">`;
      html += `<i class="fas ${verdict.is_malicious ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>`;
      html += verdict.is_malicious ? 'MALICIOUS' : 'CLEAN';
      html += `</span>`;
      html += '</div>';
      
      if (data.abuseipdb && data.abuseipdb.available) {
        html += '<div class="result-section">';
        html += '<h3><i class="fas fa-ban"></i> AbuseIPDB</h3>';
        html += `<p style="color: var(--dark-text-secondary);">Abuse Confidence Score: <strong>${data.abuseipdb.abuse_confidence_score}%</strong></p>`;
        html += `<p style="color: var(--dark-text-secondary);">Total Reports: <strong>${data.abuseipdb.total_reports}</strong></p>`;
        html += `<p style="color: var(--dark-text-secondary);">Country: <strong>${data.abuseipdb.country || 'Unknown'}</strong></p>`;
        html += '</div>';
      }
      
      html += '</div>';
      return html;
    }

    function formatDomainResult(data) {
      let html = '<div class="result">';
      html += '<div class="result-section">';
      html += '<h3><i class="fas fa-building"></i> Domain Analysis: ' + data.domain + '</h3>';
      
      const verdict = data.overall_verdict;
      html += `<span class="verdict-badge verdict-${verdict.is_malicious ? 'malicious' : 'clean'}">`;
      html += `<i class="fas ${verdict.is_malicious ? 'fa-exclamation-triangle' : 'fa-check-circle'}"></i>`;
      html += verdict.is_malicious ? 'MALICIOUS' : 'CLEAN';
      html += `</span>`;
      html += '</div>';
      
      if (data.whois && data.whois.available) {
        html += '<div class="result-section">';
        html += '<h3><i class="fas fa-globe"></i> WHOIS Information</h3>';
        html += `<p style="color: var(--dark-text-secondary);">Created: <strong>${data.whois.created_date || 'Unknown'}</strong></p>`;
        html += `<p style="color: var(--dark-text-secondary);">Age: <strong>${data.whois.age_days ? data.whois.age_days + ' days' : 'Unknown'}</strong></p>`;
        html += `<p style="color: var(--dark-text-secondary);">Registrar: <strong>${data.whois.registrar || 'Unknown'}</strong></p>`;
        if (data.whois.is_recently_registered) {
          html += '<div class="warning-box"><strong><i class="fas fa-exclamation-triangle"></i> Warning:</strong> Recently registered domain (< 30 days)</div>';
        }
        html += '</div>';
      }
      
      html += '</div>';
      return html;
    }
  </script>
  
  <script>
    function formatDate(date = new Date()) {
      return date.toISOString().split('T')[0] + ' ' + date.toLocaleTimeString();
    }

    function generateReportContent(url, verdict, confidence, maliciousSources, totalSources, analysisData) {
      const reportDate = new Date().toLocaleString();
      let report = `PhishGuard AI Analysis Report\n`;
      report += `================================\n\n`;
      report += `URL: ${url}\n`;
      report += `Analysis Date: ${reportDate}\n`;
      report += `Verdict: ${verdict}\n`;
      report += `Confidence: ${confidence}%\n`;
      report += `Threat Level: ${getThreatLevelText(confidence)}\n`;
      report += `Sources Flagged: ${maliciousSources}/${totalSources}\n\n`;
      
      // Add VirusTotal results if available
      if (analysisData.virustotal) {
        report += `VirusTotal Results:\n`;
        report += `-------------------\n`;
        if (analysisData.virustotal.detection_ratio) {
          report += `Detection Ratio: ${analysisData.virustotal.detection_ratio}\n`;
        }
        if (analysisData.virustotal.malicious !== undefined) {
          report += `Malicious: ${analysisData.virustotal.malicious ? 'Yes' : 'No'}\n`;
        }
        if (analysisData.virustotal.permalink) {
          report += `Report: ${analysisData.virustotal.permalink}\n`;
        }
        report += '\n';
      }

      // Add URLScan results if available
      if (analysisData.urlscan) {
        report += `URLScan.io Results:\n`;
        report += `-------------------\n`;
        if (analysisData.urlscan.malicious !== undefined) {
          report += `Malicious: ${analysisData.urlscan.malicious ? 'Yes' : 'No'}\n`;
        }
        if (analysisData.urlscan.report_url) {
          report += `Report: ${analysisData.urlscan.report_url}\n`;
        }
        report += '\n';
      }

      // Add Google Safe Browsing results if available
      if (analysisData.googlesafebrowsing) {
        report += `Google Safe Browsing Results:\n`;
        report += `-----------------------------\n`;
        const threats = analysisData.googlesafebrowsing.threats_found || [];
        report += `Threats Found: ${threats.length}\n`;
        threats.forEach((threat, index) => {
          report += `${index + 1}. ${threat.threatType}: ${threat.platformType} - ${threat.threatEntryType}\n`;
        });
        report += '\n';
      }

      // Add PhishTank results if available
      if (analysisData.phishtank) {
        report += `PhishTank Results:\n`;
        report += `------------------\n`;
        if (analysisData.phishtank.in_database !== undefined) {
          report += `In Database: ${analysisData.phishtank.in_database ? 'Yes' : 'No'}\n`;
        }
        if (analysisData.phishtank.verified !== undefined) {
          report += `Verified: ${analysisData.phishtank.verified ? 'Yes' : 'No'}\n`;
        }
        if (analysisData.phishtank.details_url) {
          report += `Details: ${analysisData.phishtank.details_url}\n`;
        }
      }

      report += `\n\n---\n`;
      report += `Report generated by PhishGuard AI - ${window.location.origin}\n`;
      report += `© ${new Date().getFullYear()} PhishGuard AI. All rights reserved.`;
      
      return report;
    }

    function downloadAnalysisReport(url, verdict, confidence, maliciousSources, totalSources, analysisData) {
      try {
        // Parse the analysisData if it's a string
        const data = typeof analysisData === 'string' ? JSON.parse(analysisData.replace(/&quot;/g, '"')) : analysisData;
        
        const reportContent = generateReportContent(url, verdict, confidence, maliciousSources, totalSources, data);
        const filename = `phishguard-report-${url.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${new Date().getTime()}.txt`;
        
        // Create a Blob with the report content
        const blob = new Blob([reportContent], { type: 'text/plain' });
        
        // Create a download link
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        
        // Trigger the download
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(a.href);
        }, 0);
        
        // Show success message
        showToast('Report downloaded successfully!', 'success');
      } catch (error) {
        console.error('Error generating report:', error);
        showToast('Error generating report. Please try again.', 'error');
      }
    }

    async function shareAnalysisResults(url, verdict) {
      try {
        if (navigator.share) {
          await navigator.share({
            title: 'PhishGuard AI Analysis',
            text: `PhishGuard AI Analysis for ${url} - Verdict: ${verdict}`,
            url: window.location.href,
          });
        } else {
          // Fallback for browsers that don't support Web Share API
          const shareText = `PhishGuard AI Analysis for ${url}\nVerdict: ${verdict}\n\nView full report at: ${window.location.href}`;
          
          // Try to copy to clipboard
          if (navigator.clipboard) {
            await navigator.clipboard.writeText(shareText);
            showToast('Link copied to clipboard!', 'success');
          } else {
            // Fallback to prompt
            const textArea = document.createElement('textarea');
            textArea.value = shareText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast('Link copied to clipboard!', 'success');
          }
        }
      } catch (error) {
        console.error('Error sharing results:', error);
        if (error.name !== 'AbortError') {
          showToast('Error sharing results. Please try again.', 'error');
        }
      }
    }

    function showToast(message, type = 'info') {
      // Create toast element if it doesn't exist
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.position = 'fixed';
        toastContainer.style.bottom = '20px';
        toastContainer.style.right = '20px';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toast.style.padding = '12px 20px';
      toast.style.borderRadius = '4px';
      toast.style.marginBottom = '10px';
      toast.style.color = 'white';
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.3s';
      
      // Set background color based on type
      switch (type) {
        case 'success':
          toast.style.backgroundColor = '#4CAF50';
          break;
        case 'error':
          toast.style.backgroundColor = '#f44336';
          break;
        case 'warning':
          toast.style.backgroundColor = '#ff9800';
          break;
        default:
          toast.style.backgroundColor = '#2196F3';
      }

      toastContainer.appendChild(toast);
      
      // Trigger reflow
      setTimeout(() => {
        toast.style.opacity = '1';
      }, 10);
      
      // Remove toast after delay
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 300);
      }, 3000);
    }
  </script>
  
  <script>
    function formatDate(date = new Date()) {
      return date.toISOString().split('T')[0] + ' ' + date.toLocaleTimeString();
    }

    function generateReportContent(analysisType, analysisData) {
      const reportDate = new Date().toLocaleString();
      let report = `PhishGuard AI ${analysisType.toUpperCase()} Analysis Report\n`;
      report += `================================\n\n`;
      report += `Analysis Type: ${analysisType.toUpperCase()}\n`;
      report += `Analysis Date: ${reportDate}\n`;
      
      // Common report sections
      report += `\n=== ANALYSIS DETAILS ===\n`;
      
      // Add specific content based on analysis type
      if (analysisType === 'url') {
        report += `URL: ${analysisData.url || 'N/A'}\n`;
        report += `Verdict: ${analysisData.isMalicious ? 'MALICIOUS' : 'CLEAN'}\n`;
        report += `Confidence: ${analysisData.confidence || 0}%\n`;
        report += `Threat Level: ${getThreatLevelText(analysisData.confidence || 0)}\n`;
        report += `Sources Flagged: ${analysisData.maliciousSources || 0}/${analysisData.totalSources || 0}\n`;
        
        if (analysisData.virustotal) {
          report += '\n--- VIRUSTOTAL ---\n';
          report += `Detection Ratio: ${analysisData.virustotal.detection_ratio || 'N/A'}\n`;
          report += `Malicious: ${analysisData.virustotal.malicious ? 'Yes' : 'No'}\n`;
          if (analysisData.virustotal.permalink) {
            report += `Report: ${analysisData.virustotal.permalink}\n`;
          }
        }
      } 
      else if (analysisType === 'email') {
        report += `From: ${analysisData.sender || 'N/A'}\n`;
        report += `Subject: ${analysisData.subject || 'No Subject'}\n`;
        report += `Verdict: ${analysisData.isPhishing ? 'PHISHING' : 'LEGITIMATE'}\n`;
        report += `Confidence: ${analysisData.confidence || 0}%\n`;
        report += `Risk Level: ${analysisData.riskLevel || 'Medium'}\n`;
        
        if (analysisData.suspiciousElements) {
          report += '\n--- SUSPICIOUS ELEMENTS ---\n';
          analysisData.suspiciousElements.forEach((elem, i) => {
            report += `${i+1}. ${elem.type}: ${elem.value}\n`;
            if (elem.description) {
              report += `   ${elem.description}\n`;
            }
          });
        }
      }
      else if (analysisType === 'ip') {
        report += `IP Address: ${analysisData.ip || 'N/A'}\n`;
        report += `Threat Level: ${analysisData.threatLevel || 'Unknown'}\n`;
        report += `Abuse Contact: ${analysisData.abuseContact || 'N/A'}\n`;
        report += `ISP: ${analysisData.isp || 'N/A'}\n`;
        
        if (analysisData.reputation) {
          report += '\n--- REPUTATION ---\n';
          report += `Score: ${analysisData.reputation.score || 0}/100\n`;
          report += `Blacklisted: ${analysisData.reputation.blacklisted ? 'Yes' : 'No'}\n`;
          if (analysisData.reputation.threats) {
            report += 'Threats: ' + analysisData.reputation.threats.join(', ') + '\n';
          }
        }
      }
      else if (analysisType === 'domain') {
        report += `Domain: ${analysisData.domain || 'N/A'}\n`;
        report += `Registration Date: ${analysisData.registrationDate || 'N/A'}\n`;
        report += `Expiration Date: ${analysisData.expirationDate || 'N/A'}\n`;
        report += `Registrar: ${analysisData.registrar || 'N/A'}\n`;
        report += `Status: ${analysisData.status || 'Unknown'}\n`;
        
        if (analysisData.whois) {
          report += '\n--- WHOIS ---\n';
          report += `Created: ${analysisData.whois.creation_date || 'N/A'}\n`;
          report += `Updated: ${analysisData.whois.updated_date || 'N/A'}\n`;
          report += `Registrant: ${analysisData.whois.registrant_name || 'N/A'}\n`;
          report += `Name Servers: ${(analysisData.whois.name_servers || []).join(', ') || 'N/A'}\n`;
        }
      }

      // Add footer
      report += `\n\n---\n`;
      report += `Report generated by PhishGuard AI - ${window.location.origin}\n`;
      report += `© ${new Date().getFullYear()} PhishGuard AI. All rights reserved.`;
      
      return report;
    }

    function downloadAnalysisReport(analysisType, analysisData) {
      try {
        // Parse the analysisData if it's a string
        const data = typeof analysisData === 'string' ? 
          JSON.parse(analysisData.replace(/&quot;/g, '"')) : 
          analysisData;
        
        const reportContent = generateReportContent(analysisType, data);
        const timestamp = new Date().getTime();
        const filename = `phishguard-${analysisType}-report-${timestamp}.txt`;
        
        // Create a Blob with the report content
        const blob = new Blob([reportContent], { type: 'text/plain' });
        
        // Create a download link
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        
        // Trigger the download
        document.body.appendChild(a);
        a.click();
        
        // Clean up
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(a.href);
        }, 0);
        
        // Show success message
        showToast('Report downloaded successfully!', 'success');
      } catch (error) {
        console.error('Error generating report:', error);
        showToast('Error generating report. Please try again.', 'error');
      }
    }

    function showToast(message, type = 'info') {
      // Create toast element if it doesn't exist
      let toastContainer = document.getElementById('toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.position = 'fixed';
        toastContainer.style.bottom = '20px';
        toastContainer.style.right = '20px';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toast.style.padding = '12px 20px';
      toast.style.borderRadius = '4px';
      toast.style.marginBottom = '10px';
      toast.style.color = 'white';
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.3s';
      
      // Set background color based on type
      switch (type) {
        case 'success':
          toast.style.backgroundColor = '#4CAF50';
          break;
        case 'error':
          toast.style.backgroundColor = '#f44336';
          break;
        case 'warning':
          toast.style.backgroundColor = '#ff9800';
          break;
        default:
          toast.style.backgroundColor = '#2196F3';
      }

      toastContainer.appendChild(toast);
      
      // Trigger reflow
      setTimeout(() => {
        toast.style.opacity = '1';
      }, 10);
      
      // Remove toast after delay
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // Add download buttons to all analysis sections
    document.addEventListener('DOMContentLoaded', function() {
      // Add download button to URL analysis section
      const urlResultSection = document.querySelector('#url-analysis-result');
      if (urlResultSection) {
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn btn-primary';
        downloadBtn.style.marginTop: '15px';
        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Report';
        downloadBtn.onclick = function() {
          const resultData = window.urlAnalysisResult || {};
          downloadAnalysisReport('url', resultData);
        };
        urlResultSection.appendChild(downloadBtn);
      }

      // Add download button to Email analysis section
      const emailResultSection = document.querySelector('#email-analysis-result');
      if (emailResultSection) {
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn btn-primary';
        downloadBtn.style.marginTop = '15px';
        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Report';
        downloadBtn.onclick = function() {
          const resultData = window.emailAnalysisResult || {};
          downloadAnalysisReport('email', resultData);
        };
        emailResultSection.appendChild(downloadBtn);
      }

      // Add download button to IP analysis section
      const ipResultSection = document.querySelector('#ip-analysis-result');
      if (ipResultSection) {
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn btn-primary';
        downloadBtn.style.marginTop = '15px';
        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Report';
        downloadBtn.onclick = function() {
          const resultData = window.ipAnalysisResult || {};
          downloadAnalysisReport('ip', resultData);
        };
        ipResultSection.appendChild(downloadBtn);
      }

      // Add download button to Domain analysis section
      const domainResultSection = document.querySelector('#domain-analysis-result');
      if (domainResultSection) {
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'btn btn-primary';
        downloadBtn.style.marginTop = '15px';
        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Download Report';
        downloadBtn.onclick = function() {
          const resultData = window.domainAnalysisResult || {};
          downloadAnalysisReport('domain', resultData);
        };
        domainResultSection.appendChild(downloadBtn);
      }
    });
  </script>
</body>
</html>
